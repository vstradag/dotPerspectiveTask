<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dot Perspective Task</title>

  <!-- jsPsych 7 CDN -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.2"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet">

  <style>
    html, body, #jspsych-target {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #D3D3D3;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .centered-content {
      font-size: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #continue-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #808080;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dot {
      position: absolute;
      width: 40px;
      height: 40px;
      background-color: red;
      z-index: 3;
    }
    .room-background {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    .stimulus-image {
      position: relative;
      z-index: 2;
      height: 70vh;
      display: block;
      margin: 0 auto;
    }
    body {
      background-color: #D3D3D3;
      color: black;
      font-family: Arial, sans-serif;
    }
    
    .jspsych-btn {
      background-color: #D3D3D3;
      border: 1px solid #aaa;
      border-radius: 4px;
      color: black;
      padding: 10px 20px;
      font-size: 16px;
      margin: 8px;
      cursor: pointer;
    }
    
    .jspsych-btn:hover {
      background-color: #c0c0c0;
    }
    
    .instruction-text {
      background-color: #D3D3D3;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .feedback-correct {
      font-size: 60px;
      color: green;
      font-weight: bold;
    }
    
    .feedback-incorrect {
      font-size: 60px;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
<!-- NOTE: This file must be served via a web server (e.g., localhost or GitHub Pages) -->
<div id="jspsych-target"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const jsPsych = initJsPsych({ display_element: 'jspsych-target' });

  // ======================================================
  // 1) EXACT 208-TRIAL DESIGN 
  // ======================================================
  // Each object represents one trial row.
  const mainDesignExact = [
    // --- YOU Consistent Match ---
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Match", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },

    // --- YOU Consistent Mismatch ---
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },

    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Consistent", digit_match:"Mismatch", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },

    // --- YOU Inconsistent Match ---
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"y" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"y" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"y" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Match", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },

    // --- YOU Inconsistent Mismatch ---
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:3, correct_response:"n" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:3, correct_response:"n" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:3, correct_response:"n" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"n" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"n" },

    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"YOU", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },

    // --- PERSON Consistent Match ---
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:1, correct_response:"y" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:1, correct_response:"y" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:2, correct_response:"y" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:2, correct_response:"y" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:3, correct_response:"y" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:3, correct_response:"y" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Match", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },

    // --- PERSON Consistent Mismatch ---
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:1, dots_right:0, screen_digit:2, correct_response:"n" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:0, dots_right:1, screen_digit:2, correct_response:"n" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:2, dots_right:0, screen_digit:1, correct_response:"n" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:0, dots_right:2, screen_digit:1, correct_response:"n" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:3, dots_right:0, screen_digit:1, correct_response:"n" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:0, dots_right:3, screen_digit:1, correct_response:"n" },

    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Consistent", digit_match:"Mismatch", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },

    // --- PERSON Inconsistent Match ---
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:0, correct_response:"y" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:0, correct_response:"y" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:1, correct_response:"y" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:2, correct_response:"y" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:2, correct_response:"y" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Match", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:0, correct_response:"y" },

    // --- PERSON Inconsistent Mismatch ---
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"left",  dots_left:0, dots_right:1, screen_digit:1, correct_response:"n" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:1, direction:"right", dots_left:1, dots_right:0, screen_digit:1, correct_response:"n" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"left",  dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:2, direction:"right", dots_left:1, dots_right:1, screen_digit:2, correct_response:"n" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"left",  dots_left:2, dots_right:1, screen_digit:3, correct_response:"n" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:3, direction:"right", dots_left:1, dots_right:2, screen_digit:3, correct_response:"n" },

    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:0, direction:"left",  dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" },
    { perspective:"PERSON", consistency:"Inconsistent", digit_match:"Mismatch", total_dots:0, direction:"right", dots_left:0, dots_right:0, screen_digit:1, correct_response:"n" }
  ];
  console.log("Number of rows in mainDesignExact =", mainDesignExact.length); // should be 208

  // ======================================================
  // 2) Shuffle and Evenly Assign Avatar Images
  // ======================================================
  // Simple array shuffle function.
  function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
  }

  const leftPool = ["4l.png","22l.png","30l.png","31l.png","41l.png","5l.png"];
  const rightPool = ["4r.png","22r.png","30r.png","31r.png","41r.png","5r.png"];

  function generateAvatarAssignmentPool(pool, neededCount) {
    let repeats = Math.ceil(neededCount / pool.length);
    let extended = [];
    for(let i=0; i<repeats; i++){
      extended = extended.concat(pool);
    }
    shuffle(extended);
    return extended.slice(0, neededCount);
  }

  // Randomize the entire main design.
  let mainTrialsRandomized = shuffle([...mainDesignExact]);
  let leftCount = mainTrialsRandomized.filter(tr => tr.direction==="left").length;
  let rightCount = mainTrialsRandomized.filter(tr => tr.direction==="right").length;
  let leftAssignment = generateAvatarAssignmentPool(leftPool, leftCount);
  let rightAssignment = generateAvatarAssignmentPool(rightPool, rightCount);
  mainTrialsRandomized.forEach(tr => {
    if(tr.direction==="left"){
      tr.avatar = leftAssignment.pop();
    } else {
      tr.avatar = rightAssignment.pop();
    }
  });

  // ======================================================
  // 3) Create a Representative 26-Trial Practice Block
  // ======================================================
  // For demonstration we select the first 26 from the randomized main trials.
  let practiceTrials = mainTrialsRandomized.slice(0, 26);

  // ======================================================
  // 4) Preload Images
  // ======================================================
  const allAvatars = leftPool.concat(rightPool).map(f => "https://vstradag.github.io/dotPerspectiveTask/"+f);
  const preloadImages = allAvatars.concat(["https://vstradag.github.io/dotPerspectiveTask/room.png"]);
  let timeline = [];
  timeline.push({
    type: jsPsychPreload,
    images: preloadImages
  });

  // ======================================================
  // 5) Build a Trial Sequence Following the Original Instructions
  // ======================================================
  // Define the fixation cross image URL (same as imitation task)
  const fixCrossUrl = "https://online-imitation-inhibition.github.io/imitation-inhibition-pictures/original_task/fix_cross.png";

  // Modify how we track practice performance
  let practiceCorrectCount = 0;
  let practiceTrialCount = 0;
  let practiceAttempts = 0;
  let currentlyInPractice = false;

  // Modify the buildOneTrialSequence function to handle counter resets properly
  function buildOneTrialSequence(trialObj, feedback) {
    let seq = [];
    // Fixation screen
    seq.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<img src="${fixCrossUrl}" alt="+" style="width:40px; height:40px;">`,
      choices: 'NO_KEYS',
      trial_duration: 500
    });
    
    // Cue screen (displays the perspective)
    seq.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div class="centered-content">${trialObj.perspective}</div>`,
      choices: 'NO_KEYS',
      trial_duration: 750
    });
    
    // Digit prompt screen (displays the screen digit)
    seq.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div class="centered-content">${trialObj.screen_digit}</div>`,
      choices: 'NO_KEYS',
      trial_duration: 750
    });
    
    // Scene display using working version style
    seq.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const roomUrl = 'https://vstradag.github.io/dotPerspectiveTask/room.png';
        // Create dots using the approach from the working version
        const leftDots = Array(trialObj.dots_left).fill(null).map((_, index) => {
          // Calculate positions for left wall dots
          let totalDots = trialObj.dots_left;
          let horizontalPosition;
          
          if (totalDots === 1) {
            // Single dot centered on left wall
            horizontalPosition = 10;
          } else {
            // Multiple dots, start from middle and expand
            // For left wall, smaller index = closer to center
            let spacing = 4; // Space between dots in percentage
            let startPos = 10 - (spacing * (totalDots - 1) / 2);
            horizontalPosition = startPos + (index * spacing);
          }
          
          // Fixed height at 20% from top
          return `<div class="dot" style="left: ${horizontalPosition}%; top: 20%; transform: perspective(800px) rotateY(45deg);"></div>`;
        }).join('');

        const rightDots = Array(trialObj.dots_right).fill(null).map((_, index) => {
          // Calculate positions for right wall dots
          let totalDots = trialObj.dots_right;
          let horizontalPosition;
          
          if (totalDots === 1) {
            // Single dot centered on right wall
            horizontalPosition = 10;
          } else {
            // Multiple dots, start from middle and expand
            // For right wall, larger index = closer to center
            let spacing = 4; // Space between dots in percentage
            let startPos = 10 - (spacing * (totalDots - 1) / 2);
            horizontalPosition = startPos + ((totalDots - 1 - index) * spacing); // Reversed order
          }
          
          // Fixed height at 20% from top
          return `<div class="dot" style="right: ${horizontalPosition}%; top: 20%; transform: perspective(800px) rotateY(-45deg);"></div>`;
        }).join('');
        const avatarUrl = "https://vstradag.github.io/dotPerspectiveTask/" + trialObj.avatar;
        return `<div class="stimulus-container">
                    <img class="room-background" src="${roomUrl}" style="width: 100%; position: absolute; top: 0; left: 0; z-index: 1;">
                    ${leftDots}
                    ${rightDots}
                    <img class="stimulus-image" src="${avatarUrl}" style="position: relative; z-index: 2; height: 70vh;">
                  </div>`;
      },
      choices: ['y','n'],
      trial_duration: 2000,
      data: trialObj,
      on_finish: function(data) {
        if(!data.response){
          data.correct = false;
        } else {
          let correctKey = trialObj.correct_response.toLowerCase();
          data.correct = jsPsych.pluginAPI.compareKeys(data.response, correctKey);
        }
        
        // If this is a practice trial, count it for the practice performance
        if(feedback) {
          // Only increment if we're within the expected range of trials
          if (practiceTrialCount < 26) {
            practiceTrialCount++;
            if(data.correct) {
              practiceCorrectCount++;
            }
          }
        }
        
        // Log trial information to console
        const trialType = feedback ? "PRACTICE" : "MAIN";
        const condition = `${trialObj.perspective}, ${trialObj.consistency}, ${trialObj.digit_match}`;
        const correctAnswer = trialObj.correct_response.toUpperCase();
        const givenAnswer = data.response ? data.response.toUpperCase() : "NO RESPONSE";
        const reactionTime = data.rt ? Math.round(data.rt) + "ms" : "N/A";
        
        if(feedback) {
          // Practice trial with progress information
          console.log(`${trialType} TRIAL ${practiceTrialCount}/26: Condition [${condition}], Correct Answer: ${correctAnswer}, Response: ${givenAnswer}, RT: ${reactionTime}, Correct: ${data.correct}, Total Correct: ${practiceCorrectCount}`);
        } else {
          // Main trial with detailed info similar to practice
          console.log(`${trialType} TRIAL: Condition [${condition}], Correct Answer: ${correctAnswer}, Response: ${givenAnswer}, RT: ${reactionTime}, Correct: ${data.correct}`);
        }
      }
    });
    
    // Feedback screen
    if(feedback) {
      // For practice, show correctness feedback.
      seq.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const last = jsPsych.data.get().last(1).values()[0];
          if(!last.response){
            return `<div class="centered-content" style="font-size:60px; color:red; font-weight:bold;">TOO SLOW!</div>`;
          }
          return last.correct ? 
            `<div class="feedback-correct">CORRECT!</div>` : 
            `<div class="feedback-incorrect">WRONG!</div>`;
        },
        choices: 'NO_KEYS',
        trial_duration: 1000
      });
    } else {
      // In main trials, only warn if no response.
      seq.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const last = jsPsych.data.get().last(1).values()[0];
          if(!last.response){
            return `<div class="centered-content" style="font-size:60px; color:red; font-weight:bold;">TOO SLOW!</div>`;
          }
          return '';
        },
        choices: 'NO_KEYS',
        trial_duration: 1000
      });
    }
    return seq;
  }

  // ======================================================
  // 6) Build the Practice Timeline (26 Trials)
  // ======================================================

  // Add instruction screen and initial practice setup
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="instruction-text" style="text-align:left; font-size:20px; max-width:800px; margin:0 auto;">
        <p>Each trial of this experiment will feature a room with a person (avatar) and red dots on the walls.</p>
        <p>You will be asked to count the dots either from your perspective (the entire room) or from the perspective of the person (only on the wall they face).</p>
        <p>If the number of dots matches the number shown before the scene, press 'y'. If it doesn't match, press 'n'.</p>
        <p>Please try to be as fast as possible while remaining accurate.</p>
        <p>You must get at least 80% correct on practice trials to continue.</p>
      </div>`,
    choices: ['Start practice trials'],
    button_html: '<button id="continue-button" disabled>%choice%</button>',
    on_load: () => setTimeout(() => {
      document.getElementById('continue-button').disabled = false;
      document.getElementById('continue-button').style.backgroundColor = '#4CAF50';
    }, 1500)
  });

  // Reset practice trials timeline generator
  function createPracticeTimeline() {
    // This function creates a timeline containing practice trials with a feedback summary at the end
    let practiceItems = [];
    
    // Reset counters at the start
    practiceCorrectCount = 0;
    practiceTrialCount = 0;
    practiceAttempts++;
    
    console.log(`Starting practice attempt #${practiceAttempts}`);
    
    // Add trial sequence for each practice trial
    practiceTrials.forEach(trial => {
      const trialSequence = buildOneTrialSequence(trial, true);
      practiceItems = practiceItems.concat(trialSequence);
    });
    
    // Add evaluation screen
    practiceItems.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        const percentCorrect = Math.round((practiceCorrectCount / practiceTrialCount) * 100);
        
        if (percentCorrect >= 80) {
          return `
            <div class="instruction-text" style="text-align:left; font-size:20px; max-width:800px; margin:0 auto;">
              <p style="font-size:24px;">You got it!</p>
              <p>You got ${practiceCorrectCount} out of ${practiceTrialCount} correct (${percentCorrect}%).</p>
              <p>You have successfully completed the practice trials.</p>
            </div>`;
        } else {
          return `
            <div class="instruction-text" style="text-align:left; font-size:20px; max-width:800px; margin:0 auto;">
              <p style="font-size:24px;">You've made too many mistakes.</p>
              <p>You got ${practiceCorrectCount} out of ${practiceTrialCount} correct (${percentCorrect}%).</p>
              <p>Remember, it's important to respond quickly but also to get the answers correct.</p>
              <p>Let's try again.</p>
            </div>`;
        }
      },
      choices: function() {
        const percentCorrect = Math.round((practiceCorrectCount / practiceTrialCount) * 100);
        return percentCorrect >= 80 ? ['Continue to main experiment'] : ['Restart practice'];
      },
      on_finish: function(data) {
        const percentCorrect = Math.round((practiceCorrectCount / practiceTrialCount) * 100);
        data.practice_success = percentCorrect >= 80;
        
        // If practice wasn't successful, we'll need a fresh timeline for the next attempt
        if (!data.practice_success) {
          // Reset for next attempt here as well (redundant but safe)
          practiceCorrectCount = 0;
          practiceTrialCount = 0;
        }
      }
    });
    
    return {
      timeline: practiceItems
    };
  }

  // Practice loop node that recreates the timeline fresh on each attempt
  const practiceLoop = {
    timeline: [createPracticeTimeline()],
    loop_function: function(data) {
      const lastTrial = data.last(1).values()[0];
      return !lastTrial.practice_success; // Continue loop if practice was not successful
    }
  };

  // Add the practice loop to the main timeline
  timeline.push(practiceLoop);

  // ======================================================
  // 7) Build the Main Timeline (208 Trials in Blocks of 26)
  // ======================================================
  // We use the rest of the trials (after the first 26 reserved for practice)
  let mainBlock = mainTrialsRandomized.slice(26);
  let mainTimeline = [];
  const blockSize = 26;
  for(let i = 0; i < mainBlock.length; i += blockSize) {
    const blockTrials = mainBlock.slice(i, i + blockSize);
    blockTrials.forEach(trial => {
      const trialSequence = buildOneTrialSequence(trial, false);
      mainTimeline = mainTimeline.concat(trialSequence);
    });
    // Insert a rest break between blocks (unless this is the last block)
    if(i + blockSize < mainBlock.length) {
      mainTimeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div class="centered-content" style="font-size:24px;">Take a brief rest. Press any key to continue.</div>`,
        choices: 'ALL_KEYS'
      });
    }
  }

  // ======================================================
  // 8) Assemble the Full Timeline and Run
  // ======================================================
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="instruction-text" style="text-align:left; font-size:20px; max-width:800px; margin:0 auto;">
        <p>Practice is complete.</p>
        <p>The main experiment will now begin. Remember: you will only be warned if you respond too slowly.</p>
      </div>`,
    choices: ['Start Main Experiment']
  });
  timeline = timeline.concat(mainTimeline);

  jsPsych.run(timeline);
});
</script>
</body>
</html>
